<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Installation Guide | ngx_waf</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="A web application firewall module for nginx without complex configuration.'">
    
    <link rel="preload" href="/ngx_waf/assets/css/0.styles.50317297.css" as="style"><link rel="preload" href="/ngx_waf/assets/js/app.7227ec30.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/2.eb25f57f.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/18.acef0db5.js" as="script"><link rel="prefetch" href="/ngx_waf/assets/js/10.8810753a.js"><link rel="prefetch" href="/ngx_waf/assets/js/11.adb805e5.js"><link rel="prefetch" href="/ngx_waf/assets/js/12.c1a5cf21.js"><link rel="prefetch" href="/ngx_waf/assets/js/13.77b83033.js"><link rel="prefetch" href="/ngx_waf/assets/js/14.0f885992.js"><link rel="prefetch" href="/ngx_waf/assets/js/15.3d87812c.js"><link rel="prefetch" href="/ngx_waf/assets/js/16.ef824661.js"><link rel="prefetch" href="/ngx_waf/assets/js/17.b0e6891f.js"><link rel="prefetch" href="/ngx_waf/assets/js/19.49f18637.js"><link rel="prefetch" href="/ngx_waf/assets/js/20.289a2d7b.js"><link rel="prefetch" href="/ngx_waf/assets/js/21.9e12a8b6.js"><link rel="prefetch" href="/ngx_waf/assets/js/22.7a454a14.js"><link rel="prefetch" href="/ngx_waf/assets/js/23.99d8ff57.js"><link rel="prefetch" href="/ngx_waf/assets/js/24.93976249.js"><link rel="prefetch" href="/ngx_waf/assets/js/25.7e9e286f.js"><link rel="prefetch" href="/ngx_waf/assets/js/26.ab657cbc.js"><link rel="prefetch" href="/ngx_waf/assets/js/27.ae524303.js"><link rel="prefetch" href="/ngx_waf/assets/js/28.25a127ef.js"><link rel="prefetch" href="/ngx_waf/assets/js/29.16ac2f86.js"><link rel="prefetch" href="/ngx_waf/assets/js/3.91d830cd.js"><link rel="prefetch" href="/ngx_waf/assets/js/30.17d1f556.js"><link rel="prefetch" href="/ngx_waf/assets/js/31.2208426a.js"><link rel="prefetch" href="/ngx_waf/assets/js/32.86ae5339.js"><link rel="prefetch" href="/ngx_waf/assets/js/33.82942a65.js"><link rel="prefetch" href="/ngx_waf/assets/js/34.670b7d56.js"><link rel="prefetch" href="/ngx_waf/assets/js/35.10c1d185.js"><link rel="prefetch" href="/ngx_waf/assets/js/36.d02611ca.js"><link rel="prefetch" href="/ngx_waf/assets/js/37.37793c51.js"><link rel="prefetch" href="/ngx_waf/assets/js/38.9a13061c.js"><link rel="prefetch" href="/ngx_waf/assets/js/39.ee40b227.js"><link rel="prefetch" href="/ngx_waf/assets/js/4.ec1e089c.js"><link rel="prefetch" href="/ngx_waf/assets/js/40.d357aae9.js"><link rel="prefetch" href="/ngx_waf/assets/js/5.599c80f5.js"><link rel="prefetch" href="/ngx_waf/assets/js/6.c04646c9.js"><link rel="prefetch" href="/ngx_waf/assets/js/7.85822b87.js"><link rel="prefetch" href="/ngx_waf/assets/js/8.b4a20a3a.js"><link rel="prefetch" href="/ngx_waf/assets/js/9.7e407dd0.js">
    <link rel="stylesheet" href="/ngx_waf/assets/css/0.styles.50317297.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ngx_waf/" class="home-link router-link-active"><!----> <span class="site-name">ngx_waf</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/guide/installation.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/guide/installation.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/guide/installation.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/guide/installation.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/guide/overview.html" class="sidebar-heading clickable open"><span>Quick Start</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ngx_waf/guide/overview.html" class="sidebar-link">Overview</a></li><li><a href="/ngx_waf/guide/version.html" class="sidebar-link">Version Description</a></li><li><a href="/ngx_waf/guide/compatibility.html" class="sidebar-link">Compatibility Statement</a></li><li><a href="/ngx_waf/guide/installation.html" aria-current="page" class="active sidebar-link">Installation Guide</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#docker" class="sidebar-link">Docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#pulling-remote-images" class="sidebar-link">Pulling Remote Images</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#build-locally" class="sidebar-link">Build Locally</a></li></ul></li><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#compile-and-install" class="sidebar-link">Compile And Install</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#static-modules" class="sidebar-link">Static Modules</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/guide/installation.html#dynamic-modules" class="sidebar-link">Dynamic Modules</a></li></ul></li></ul></li><li><a href="/ngx_waf/guide/configuration.html" class="sidebar-link">Configuration Guide</a></li><li><a href="/ngx_waf/guide/test.html" class="sidebar-link">Test</a></li><li><a href="/ngx_waf/guide/faq.html" class="sidebar-link">FAQ</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/advance/directive.html" class="sidebar-heading clickable"><span>Advanced Guide</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/todo/overview.html" class="sidebar-heading clickable"><span>TODO (Advice Needed)</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="installation-guide"><a href="#installation-guide" class="header-anchor">#</a> Installation Guide</h1> <p>This module provides two ways of installation, Docker and compiled.</p> <h2 id="docker"><a href="#docker" class="header-anchor">#</a> Docker</h2> <p>This module provides two ways to get Docker images, pulling remote images and building images locally.</p> <p>The image is built based on the official Docker image,
see <a href="https://hub.docker.com/r/addsp/ngx_waf" target="_blank" rel="noopener noreferrer">Docker image repository<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for usage.</p> <div class="custom-block tip"><p class="custom-block-title">Note</p> <p>Many people have less trust in non-official Docker images, and I do too.
If you do, it is recommended that you build the image locally.
If you are willing to trust the author of this module,
it is recommended that you pull the image built by the author directly.</p></div> <h3 id="pulling-remote-images"><a href="#pulling-remote-images" class="header-anchor">#</a> Pulling Remote Images</h3> <p>This module uploads the corresponding Docker images each time the stable and development versions are updated,
and rebuilds all images at 00:00:00 UTC on Sunday.</p> <p>You can choose one of the following two commands to pull an image that has already been built.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>docker pull addsp/ngx_waf:stable

docker pull addsp/ngx_waf:stable-alpine
</code></pre></div><h3 id="build-locally"><a href="#build-locally" class="header-anchor">#</a> Build Locally</h3> <p>This module provides two Dockerfile files in the root directory to guide the image build.
They are <code>docker/Dockerfile.alpine</code> and <code>docker/Dockerfile.debian</code>, respectively.
The former is built based on <code>nginx:stable-alpine</code> and the latter is built based on <code>nginx:stable</code>.</p> <p>You can choose one of the following two commands to build the image</p> <div class="language-sh extra-class"><pre class="language-sh"><code>docker build -t nginx:stable-alpine-with-ngx_waf -f docker/Dockerfile.alpine <span class="token builtin class-name">.</span>

docker build -t nginx:stable-with-ngx_waf -f docker/Dockerfile.debian <span class="token builtin class-name">.</span>
</code></pre></div><h2 id="compile-and-install"><a href="#compile-and-install" class="header-anchor">#</a> Compile And Install</h2> <p>nginx provides two ways to install modules, namely &quot;static linking&quot; and &quot;dynamic loading&quot;,
and the modules installed in these two ways are called &quot;static modules&quot; and &quot;dynamic modules&quot; respectively.</p> <div class="custom-block warning"><p class="custom-block-title">NOTE</p> <p>Compiling and installing the module may require some dependencies,
such as <code>gcc</code>,
so please work out the dependencies yourself; this article does not provide such information.</p></div> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>Compiling and installing a new module requires knowing the parameters of the current nginx's <code>configure</code> script,
which you can get by running <code>nginx -V</code>.
Here is an example.</p> <div class="language- extra-class"><pre class="language-text"><code>nginx version: nginx/1.19.6
built by gcc 9.3.0 (Ubuntu 9.3.0-17ubuntu1~20.04)
built with OpenSSL 1.1.1i  8 Dec 2020
TLS SNI support enabled
configure arguments: --with-mail=dynamic --with-openssl=/usr/local/src/openssl-OpenSSL_1_1_1i --prefix=/usr/local/nginx --user=nginx --group=nginx --with-file-aio --with-http_ssl_module --with-http_geoip_module --with-http_v2_module --with-http_realip_module --with-stream_ssl_preread_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_perl_module --with-http_stub_status_module --with-http_auth_request_module --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-debug --with-cc-opt='-O3 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic'
</code></pre></div><p>Be sure to remember what comes after <code>configure arguments:</code>, which will be replaced by <code>ARG</code> below.</p></div> <h3 id="static-modules"><a href="#static-modules" class="header-anchor">#</a> Static Modules</h3> <p>Installing a static module requires recompiling the entire nginx, which takes longer than installing a dynamic module.</p> <p>First download the corresponding version of nginx, <a href="http://nginx.org/en/download.html" target="_blank" rel="noopener noreferrer">download page<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.
The following is an example of <code>nginx-1.20.1</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /usr/local/src
<span class="token function">wget</span> https://nginx.org/download/nginx-1.20.1.tar.gz
<span class="token function">tar</span> -zxf nginx-1.20.1.tar.gz
</code></pre></div><p>Then download the source code of this module, the following will use the stable version of the source code</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /usr/local/src
<span class="token comment"># If you want to use the development version please replace '-b master' with '-b dev'.</span>
<span class="token function">git</span> clone -b master https://github.com/ADD-SP/ngx_waf.git
<span class="token builtin class-name">cd</span> ngx_waf
<span class="token function">git</span> clone https://github.com/libinjection/libinjection.git inc/libinjection
</code></pre></div><p>Next you should run the configuration script.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">cd</span> /usr/local/src/nginx-1.20.1
./configure ARG --add-module<span class="token operator">=</span>/usr/local/src/ngx_waf
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">NOTE</p> <ul><li><p>The meaning of <code>ARG</code> is given in <a href="#compile-and-install">Compile And Install</a>.</p></li> <li><p>If you are using GCC as your compiler, append <code>-fstack-protector-strong</code> to <code>-with-cc-opt</code>.
For example <code>--with-cc-opt='-Werror -g'</code> ---&gt; <code>--with-cc-opt='-Werror -g -fstack-protector-strong'</code></p></li></ul></div> <p>Then start compiling.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token comment"># Not using parallel compilation</span>
<span class="token function">make</span>

<span class="token comment"># Use parallel compilation.</span>
<span class="token function">make</span> -j<span class="token variable"><span class="token variable">$(</span>nproc<span class="token variable">)</span></span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>Parallel compilation will improve the compilation speed, but there is a chance of strange errors,
so you can disable parallel compilation if it goes wrong.</p></div> <p>Finally, you should stop nginx and replace the nginx binary.
Assume here that the absolute path to the nginx binary is <code>/usr/local/nginx/sbin/nginx</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">cp</span> objs/nginx /usr/local/nginx/sbin/nginx
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Hot Deployment</p> <p>If you do not want to not nginx when replacing binaries, you can refer to the <a href="http://nginx.org/en/docs/control.html" target="_blank" rel="noopener noreferrer">official documentation for hot deployment scenarios<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <h3 id="dynamic-modules"><a href="#dynamic-modules" class="header-anchor">#</a> Dynamic Modules</h3> <p>Compiling and installing dynamic modules does not require recompiling the entire nginx,
only all modules, which is faster than static modules,
which is the recommended way in this document.</p> <p>The process of downloading nginx source code and module source code is the same as for <a href="#static-modules">Static Modules</a> and will not be repeated.</p> <p>Run the configuration script</p> <div class="language-sh extra-class"><pre class="language-sh"><code>./configure --add-dynamic-module<span class="token operator">=</span>/usr/local/src/ngx_waf --with-compat
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">NOTE</p> <ul><li>If you are using GCC as your compiler, append <code>-fstack-protector-strong</code> to <code>-with-cc-opt</code>.
For example <code>--with-cc-opt='-Werror -g'</code> ---&gt; <code>--with-cc-opt='-Werror -g -fstack-protector-strong'</code></li></ul></div> <p>Then start compiling the dynamic module</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">make</span> modules
</code></pre></div><p>You should then stop nginx and copy the dynamic modules to the modules directory.
Assume here that the absolute path to the modules directory is <code>/usr/local/nginx/modules</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">cp</span> objs/*.so /usr/local/nginx/modules
</code></pre></div><p>Finally, add a line to the top of the nginx configuration file.</p> <div class="language-vim extra-class"><pre class="language-vim"><code>load_module <span class="token string">&quot;/usr/local/nginx/modules/ngx_http_waf_module.so&quot;</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ADD-SP/ngx_waf/edit/master/docs/guide/installation.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/9/2021, 10:59:52 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ngx_waf/guide/compatibility.html" class="prev">
        Compatibility Statement
      </a></span> <span class="next"><a href="/ngx_waf/guide/configuration.html">
        Configuration Guide
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ngx_waf/assets/js/app.7227ec30.js" defer></script><script src="/ngx_waf/assets/js/2.eb25f57f.js" defer></script><script src="/ngx_waf/assets/js/18.acef0db5.js" defer></script>
  </body>
</html>
