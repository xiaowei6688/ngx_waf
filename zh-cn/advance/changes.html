<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>更新日志 | ngx_waf</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="使用简单的 nginx 防火墙模块">
    
    <link rel="preload" href="/ngx_waf/assets/css/0.styles.50317297.css" as="style"><link rel="preload" href="/ngx_waf/assets/js/app.7227ec30.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/2.eb25f57f.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/25.7e9e286f.js" as="script"><link rel="prefetch" href="/ngx_waf/assets/js/10.8810753a.js"><link rel="prefetch" href="/ngx_waf/assets/js/11.adb805e5.js"><link rel="prefetch" href="/ngx_waf/assets/js/12.c1a5cf21.js"><link rel="prefetch" href="/ngx_waf/assets/js/13.77b83033.js"><link rel="prefetch" href="/ngx_waf/assets/js/14.0f885992.js"><link rel="prefetch" href="/ngx_waf/assets/js/15.3d87812c.js"><link rel="prefetch" href="/ngx_waf/assets/js/16.ef824661.js"><link rel="prefetch" href="/ngx_waf/assets/js/17.b0e6891f.js"><link rel="prefetch" href="/ngx_waf/assets/js/18.acef0db5.js"><link rel="prefetch" href="/ngx_waf/assets/js/19.49f18637.js"><link rel="prefetch" href="/ngx_waf/assets/js/20.289a2d7b.js"><link rel="prefetch" href="/ngx_waf/assets/js/21.9e12a8b6.js"><link rel="prefetch" href="/ngx_waf/assets/js/22.7a454a14.js"><link rel="prefetch" href="/ngx_waf/assets/js/23.99d8ff57.js"><link rel="prefetch" href="/ngx_waf/assets/js/24.93976249.js"><link rel="prefetch" href="/ngx_waf/assets/js/26.ab657cbc.js"><link rel="prefetch" href="/ngx_waf/assets/js/27.ae524303.js"><link rel="prefetch" href="/ngx_waf/assets/js/28.25a127ef.js"><link rel="prefetch" href="/ngx_waf/assets/js/29.16ac2f86.js"><link rel="prefetch" href="/ngx_waf/assets/js/3.91d830cd.js"><link rel="prefetch" href="/ngx_waf/assets/js/30.17d1f556.js"><link rel="prefetch" href="/ngx_waf/assets/js/31.2208426a.js"><link rel="prefetch" href="/ngx_waf/assets/js/32.86ae5339.js"><link rel="prefetch" href="/ngx_waf/assets/js/33.82942a65.js"><link rel="prefetch" href="/ngx_waf/assets/js/34.670b7d56.js"><link rel="prefetch" href="/ngx_waf/assets/js/35.10c1d185.js"><link rel="prefetch" href="/ngx_waf/assets/js/36.d02611ca.js"><link rel="prefetch" href="/ngx_waf/assets/js/37.37793c51.js"><link rel="prefetch" href="/ngx_waf/assets/js/38.9a13061c.js"><link rel="prefetch" href="/ngx_waf/assets/js/39.ee40b227.js"><link rel="prefetch" href="/ngx_waf/assets/js/4.ec1e089c.js"><link rel="prefetch" href="/ngx_waf/assets/js/40.d357aae9.js"><link rel="prefetch" href="/ngx_waf/assets/js/5.599c80f5.js"><link rel="prefetch" href="/ngx_waf/assets/js/6.c04646c9.js"><link rel="prefetch" href="/ngx_waf/assets/js/7.85822b87.js"><link rel="prefetch" href="/ngx_waf/assets/js/8.b4a20a3a.js"><link rel="prefetch" href="/ngx_waf/assets/js/9.7e407dd0.js">
    <link rel="stylesheet" href="/ngx_waf/assets/css/0.styles.50317297.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ngx_waf/zh-cn/" class="home-link router-link-active"><!----> <span class="site-name">ngx_waf</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/advance/changes.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/advance/changes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/advance/changes.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/advance/changes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/zh-cn/guide/overview.html" class="sidebar-heading clickable"><span>快速上手</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/zh-cn/advance/directive.html" class="sidebar-heading clickable open"><span>进阶指南</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ngx_waf/zh-cn/advance/directive.html" class="sidebar-link">配置语法</a></li><li><a href="/ngx_waf/zh-cn/advance/rule.html" class="sidebar-link">规则说明</a></li><li><a href="/ngx_waf/zh-cn/advance/priority.html" class="sidebar-link">规则优先级</a></li><li><a href="/ngx_waf/zh-cn/advance/variable.html" class="sidebar-link">内置变量</a></li><li><a href="/ngx_waf/zh-cn/advance/log.html" class="sidebar-link">日志</a></li><li><a href="/ngx_waf/zh-cn/advance/issue.html" class="sidebar-link">已知问题</a></li><li><a href="/ngx_waf/zh-cn/advance/changes.html" aria-current="page" class="active sidebar-link">更新日志</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#未发布" class="sidebar-link">[未发布]</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-4-1-2021-06-09-utc-0800" class="sidebar-link">[5.4.1] - 2021-06-09 UTC+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-4-0-2021-06-03-utc-0800" class="sidebar-link">[5.4.0] - 2021-06-03 UTC+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-3-2-2021-05-28-utc-0800" class="sidebar-link">[5.3.2] - 2021-05-28 UTC+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-3-1-2021-05-26-gmt-0800" class="sidebar-link">[5.3.1] - 2021-05-26 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-3-0-2021-05-16-gmt-0800" class="sidebar-link">[5.3.0] - 2021-05-16 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-1-2-2021-04-30-gmt-0800" class="sidebar-link">[5.1.2] - 2021-04-30 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-1-1-2021-04-23-gmt-0800" class="sidebar-link">[5.1.1] - 2021-04-23 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-1-0-2021-04-20-gmt-0800" class="sidebar-link">[5.1.0] - 2021-04-20 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_5-0-0-2021-04-07-gmt-0800" class="sidebar-link">[5.0.0] - 2021-04-07 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_4-0-0-2021-03-22-gmt-0800" class="sidebar-link">[4.0.0] - 2021-03-22 GMT+0800</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-6-2021-03-07" class="sidebar-link">[3.1.6] - 2021-03-07</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-5-2021-03-03" class="sidebar-link">[3.1.5] - 2021-03-03</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-4-2021-03-02" class="sidebar-link">[3.1.4] - 2021-03-02</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-3-2021-02-23" class="sidebar-link">[3.1.3] - 2021-02-23</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-2-2021-02-17" class="sidebar-link">[3.1.2] - 2021-02-17</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-1-2021-01-18" class="sidebar-link">[3.1.1] - 2021-01-18</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-1-0-2021-01-17" class="sidebar-link">[3.1.0] - 2021-01-17</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-0-2-2021-01-10" class="sidebar-link">[3.0.2] - 2021-01-10</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-0-1-2020-12-28" class="sidebar-link">[3.0.1] - 2020-12-28</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_3-0-0-2020-12-25" class="sidebar-link">[3.0.0] - 2020-12-25</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_2-1-1-2020-12-10" class="sidebar-link">[2.1.1] - 2020-12-10</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_2-1-0-2020-12-09" class="sidebar-link">[2.1.0] - 2020-12-09</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_2-0-2-2020-12-07" class="sidebar-link">[2.0.2] - 2020-12-07</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_2-0-1-2020-12-03" class="sidebar-link">[2.0.1] - 2020-12-03</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_2-0-0-2020-09-29" class="sidebar-link">[2.0.0] - 2020-09-29</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_1-0-1-2020-08-22" class="sidebar-link">[1.0.1] - 2020-08-22</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/zh-cn/advance/changes.html#_1-0-0-2020-08-18" class="sidebar-link">[1.0.0] - 2020-08-18</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/zh-cn/todo/overview.html" class="sidebar-heading clickable"><span>开发计划（建议征集）</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="更新日志"><a href="#更新日志" class="header-anchor">#</a> 更新日志</h1> <h2 id="未发布"><a href="#未发布" class="header-anchor">#</a> [未发布]</h2> <h3 id="新增"><a href="#新增" class="header-anchor">#</a> 新增</h3> <h3 id="移除"><a href="#移除" class="header-anchor">#</a> 移除</h3> <h3 id="变动"><a href="#变动" class="header-anchor">#</a> 变动</h3> <h3 id="修复"><a href="#修复" class="header-anchor">#</a> 修复</h3> <ul><li>如果启用了 POST 检测，则访问日志（access_log）中不会记录 POST 请求，即丢失所有的 POST 请求的日志。</li></ul> <hr> <h2 id="_5-4-1-2021-06-09-utc-0800"><a href="#_5-4-1-2021-06-09-utc-0800" class="header-anchor">#</a> [5.4.1] - 2021-06-09 UTC+0800</h2> <h3 id="修复-2"><a href="#修复-2" class="header-anchor">#</a> 修复</h3> <ul><li>当使用了 <code>error_page</code> 配置时，内置变量的值可能会出错。</li></ul> <hr> <h2 id="_5-4-0-2021-06-03-utc-0800"><a href="#_5-4-0-2021-06-03-utc-0800" class="header-anchor">#</a> [5.4.0] - 2021-06-03 UTC+0800</h2> <h3 id="注意"><a href="#注意" class="header-anchor">#</a> <strong>注意</strong></h3> <p><strong>本次更新更换了 libinjection 的 clone 链接，新的链接为 <a href="https://github.com/libinjection/libinjection.git" target="_blank" rel="noopener noreferrer">https://github.com/libinjection/libinjection.git<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</strong></p> <h3 id="新增-2"><a href="#新增-2" class="header-anchor">#</a> 新增</h3> <ul><li>XSS 攻击防御（Powered By <a href="https://github.com/libinjection/libinjection" target="_blank" rel="noopener noreferrer">libinjection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="变动-2"><a href="#变动-2" class="header-anchor">#</a> 变动</h3> <ul><li>增加内置变量计算相关的调试日志。</li></ul> <h3 id="修复-3"><a href="#修复-3" class="header-anchor">#</a> 修复</h3> <ul><li>POST 检测失效。</li></ul> <hr> <h2 id="_5-3-2-2021-05-28-utc-0800"><a href="#_5-3-2-2021-05-28-utc-0800" class="header-anchor">#</a> [5.3.2] - 2021-05-28 UTC+0800</h2> <h3 id="修复-4"><a href="#修复-4" class="header-anchor">#</a> 修复</h3> <ul><li>内存损坏。</li></ul> <hr> <h2 id="_5-3-1-2021-05-26-gmt-0800"><a href="#_5-3-1-2021-05-26-gmt-0800" class="header-anchor">#</a> [5.3.1] - 2021-05-26 GMT+0800</h2> <h3 id="修复-5"><a href="#修复-5" class="header-anchor">#</a> 修复</h3> <ul><li>有时即使正确安装了依赖也不能编译模块。</li></ul> <hr> <h2 id="_5-3-0-2021-05-16-gmt-0800"><a href="#_5-3-0-2021-05-16-gmt-0800" class="header-anchor">#</a> [5.3.0] - 2021-05-16 GMT+0800</h2> <h3 id="新增-3"><a href="#新增-3" class="header-anchor">#</a> 新增</h3> <ul><li><p>新的配置：<code>waf_under_attack</code>，当网站受到攻击时可以使用。</p></li> <li><p>新的配置：<code>waf_http_status</code>，用于设置请求被拦截后返回的 HTTP 状态码。</p></li> <li><p>新的内置变量：<code>$waf_blocking_log</code>，当请求被拦截其值时不为空字符串。</p></li></ul> <h3 id="变动-3"><a href="#变动-3" class="header-anchor">#</a> 变动</h3> <ul><li>更新了默认规则。</li></ul> <h3 id="修复-6"><a href="#修复-6" class="header-anchor">#</a> 修复</h3> <ul><li><p>CC 防护有时会失效。</p></li> <li><p>Cookie 防护有时会失效。</p></li></ul> <hr> <h2 id="_5-1-2-2021-04-30-gmt-0800"><a href="#_5-1-2-2021-04-30-gmt-0800" class="header-anchor">#</a> [5.1.2] - 2021-04-30 GMT+0800</h2> <h3 id="新增-4"><a href="#新增-4" class="header-anchor">#</a> 新增</h3> <ul><li>支持检测 SQL 注入（Powered By <a href="https://github.com/libinjection/libinjection" target="_blank" rel="noopener noreferrer">libinjection<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。你可以通过启用 <code>LIB-INJECTION</code> 模式开启该功能，详见使用文档。</li></ul> <hr> <h2 id="_5-1-1-2021-04-23-gmt-0800"><a href="#_5-1-1-2021-04-23-gmt-0800" class="header-anchor">#</a> [5.1.1] - 2021-04-23 GMT+0800</h2> <h3 id="修复-7"><a href="#修复-7" class="header-anchor">#</a> 修复</h3> <ul><li>URL 和 Referer 白名单规则失效。</li></ul> <hr> <h2 id="_5-1-0-2021-04-20-gmt-0800"><a href="#_5-1-0-2021-04-20-gmt-0800" class="header-anchor">#</a> [5.1.0] - 2021-04-20 GMT+0800</h2> <h3 id="新增-5"><a href="#新增-5" class="header-anchor">#</a> 新增</h3> <ul><li><p>新的内置变量 <code>waf_log</code>，当本模块进行了检查时不为空字符串，反之则为空字符串，主要用于 <code>access_log</code> 指令。</p></li> <li><p>新的内置变量 <code>waf_spend</code>，记录本模块执行检查花费的时间（毫秒）。</p></li></ul> <hr> <h2 id="_5-0-0-2021-04-07-gmt-0800"><a href="#_5-0-0-2021-04-07-gmt-0800" class="header-anchor">#</a> [5.0.0] - 2021-04-07 GMT+0800</h2> <h3 id="警告"><a href="#警告" class="header-anchor">#</a> <strong>警告</strong></h3> <p><strong>此版本包含不兼容的更新（breaking changes）。</strong></p> <h3 id="新增-6"><a href="#新增-6" class="header-anchor">#</a> 新增</h3> <ul><li><p>新增了模式 <code>CACHE</code>，启用此模式后会缓存每次检查的结果，提高性能。</p></li> <li><p>新增了配置 <code>waf_cache</code> 用于设置缓存相关的参数。</p></li> <li><p>新增了配置 <code>waf_cc_deny</code>，用于设置 CC 防护相关的参数。</p></li> <li><p>新增了配置 <code>waf_priority</code>，用来设置除了 POST 检查以外所有的检查项目的优先级。</p></li> <li><p>当 CC 防护返回 503 状态码时会附上 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Retry-After" target="_blank" rel="noopener noreferrer">Retry-After<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 响应头。</p></li></ul> <h3 id="移除-2"><a href="#移除-2" class="header-anchor">#</a> 移除</h3> <ul><li>废弃了配置 <code>waf_cc_deny_limit</code>，使用新的配置 <code>waf_cc_deny</code> 替代。</li></ul> <h3 id="变动-4"><a href="#变动-4" class="header-anchor">#</a> 变动</h3> <ul><li>互换了 CC 防护和 IP 白名单检查的默认优先级。</li></ul> <h3 id="修复-8"><a href="#修复-8" class="header-anchor">#</a> 修复</h3> <ul><li><p>修复了当 worker 进程数量大于一时的段错误。</p></li> <li><p>修复了 CC 防护统计有时不准的错误。</p></li></ul> <hr> <h2 id="_4-0-0-2021-03-22-gmt-0800"><a href="#_4-0-0-2021-03-22-gmt-0800" class="header-anchor">#</a> [4.0.0] - 2021-03-22 GMT+0800</h2> <h3 id="警告-2"><a href="#警告-2" class="header-anchor">#</a> <strong>警告</strong></h3> <p><strong>此版本包含不兼容的更新（breaking changes）。</strong></p> <h3 id="新增-7"><a href="#新增-7" class="header-anchor">#</a> 新增</h3> <ul><li>为 <code>waf_mode</code> 和 <code>waf_cc_deny_limit</code> 增加了一些参数（<a href="https://github.com/ADD-SP/ngx_waf/commit/368db2b26e9d2a910c06e77f892740cefe9556d3" target="_blank" rel="noopener noreferrer">368db2b<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="移除-3"><a href="#移除-3" class="header-anchor">#</a> 移除</h3> <ul><li>废弃配置项 <code>waf_mult_mount</code>，该配置的功能已经合并到了配置项 <code>waf_mode</code> 中。</li></ul> <h3 id="变动-5"><a href="#变动-5" class="header-anchor">#</a> 变动</h3> <ul><li>给 <code>waf_mode</code> 增加了一些参数。</li></ul> <h3 id="修复-9"><a href="#修复-9" class="header-anchor">#</a> 修复</h3> <ul><li><p>更正了内置变量 <code>waf_rule_details</code> 的名称错误，该变量的名称在之前的版本代码中被设置为 <code>waf_rule_deatails</code>。</p></li> <li><p>不再进行冗余的检测。</p></li> <li><p>彻底解决了与 <code>ngx_http_rewrite_module</code> 的兼容性问题。</p></li></ul> <hr> <h2 id="_3-1-6-2021-03-07"><a href="#_3-1-6-2021-03-07" class="header-anchor">#</a> [3.1.6] - 2021-03-07</h2> <h3 id="修复-10"><a href="#修复-10" class="header-anchor">#</a> 修复</h3> <ul><li>更正规则的生效顺序（<a href="https://github.com/ADD-SP/ngx_waf/commit/51c7824786c060f4b0dcffe77a4a1e04b775e04b" target="_blank" rel="noopener noreferrer">51c7824<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-5-2021-03-03"><a href="#_3-1-5-2021-03-03" class="header-anchor">#</a> [3.1.5] - 2021-03-03</h2> <h3 id="修复-11"><a href="#修复-11" class="header-anchor">#</a> 修复</h3> <ul><li>修复了 <code>config</code> 脚本的一个错误，这个错误会导致不能正确地检查依赖项（<a href="https://github.com/ADD-SP/ngx_waf/commit/075a27e4f7aaf7e78c45eac0c78c9634863be476#diff-b79606fb3afea5bd1609ed40b622142f1c98125abcfe89a76a661b0e8e343910" target="_blank" rel="noopener noreferrer">075a27e<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-4-2021-03-02"><a href="#_3-1-4-2021-03-02" class="header-anchor">#</a> [3.1.4] - 2021-03-02</h2> <h3 id="改动"><a href="#改动" class="header-anchor">#</a> 改动</h3> <ul><li>条件允许的情况下使用更安全的字符串处理函数以避免缓冲区溢出（<a href="https://github.com/ADD-SP/ngx_waf/commit/177ae68cb019f47096e6065ec34aa0ef9be07567" target="_blank" rel="noopener noreferrer">177ae68<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-3-2021-02-23"><a href="#_3-1-3-2021-02-23" class="header-anchor">#</a> [3.1.3] - 2021-02-23</h2> <h3 id="修复-12"><a href="#修复-12" class="header-anchor">#</a> 修复</h3> <ul><li>改正规则的生效顺序（<a href="https://github.com/ADD-SP/ngx_waf/commit/857ec84c6519d88d1c1a5560a244dceffd413f3f" target="_blank" rel="noopener noreferrer">857ec84<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-2-2021-02-17"><a href="#_3-1-2-2021-02-17" class="header-anchor">#</a> [3.1.2] - 2021-02-17</h2> <h3 id="修复-13"><a href="#修复-13" class="header-anchor">#</a> 修复</h3> <ul><li>修复了一个 bug，这个 bug 会导致当规则文件不具有可写权限时初始化失败（<a href="https://github.com/ADD-SP/ngx_waf/commit/20acd27815d1f266d89c1557e93848c96117b8ff" target="_blank" rel="noopener noreferrer">20acd27<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-1-2021-01-18"><a href="#_3-1-1-2021-01-18" class="header-anchor">#</a> [3.1.1] - 2021-01-18</h2> <h3 id="修复-14"><a href="#修复-14" class="header-anchor">#</a> 修复</h3> <ul><li>兼容较低版本的 GCC（<a href="https://github.com/ADD-SP/ngx_waf/commit/becbbe022b9f6efa606e720d7cbcd6c5d6f22c33" target="_blank" rel="noopener noreferrer">becbbe0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-1-0-2021-01-17"><a href="#_3-1-0-2021-01-17" class="header-anchor">#</a> [3.1.0] - 2021-01-17</h2> <h3 id="注意-2"><a href="#注意-2" class="header-anchor">#</a> 注意</h3> <ul><li>因为在 <code>v3.0.3</code> 测试过程中新增了向下兼容的功能，所以 <code>v3.0.3</code> 被跳过。</li></ul> <h3 id="新增-8"><a href="#新增-8" class="header-anchor">#</a> 新增</h3> <ul><li>增加调试日志便于排障（<a href="https://github.com/ADD-SP/ngx_waf/commit/bac1d026e9e902d9a49881e899cba4965f3388a4" target="_blank" rel="noopener noreferrer">bac1d02<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="修复-15"><a href="#修复-15" class="header-anchor">#</a> 修复</h3> <ul><li><p>修复了一个段错误（<a href="https://github.com/ADD-SP/ngx_waf/commit/57d7719654caddc40ee655c797f0984f42c25495" target="_blank" rel="noopener noreferrer">57d7719<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li> <li><p>更精确的访问频次统计（<a href="https://github.com/ADD-SP/ngx_waf/commit/53d3b149a524252dbb9b8170e31f4b1f4895a6b7" target="_blank" rel="noopener noreferrer">53d3b14<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li></ul> <hr> <h2 id="_3-0-2-2021-01-10"><a href="#_3-0-2-2021-01-10" class="header-anchor">#</a> [3.0.2] - 2021-01-10</h2> <h3 id="注意-3"><a href="#注意-3" class="header-anchor">#</a> 注意</h3> <ul><li>因为在 <code>v3.0.1</code>上有热修复，所以 <code>v3.0.2</code> 的一切测试版本作废，请不要使用这些测试版。</li></ul> <h3 id="修复-16"><a href="#修复-16" class="header-anchor">#</a> 修复</h3> <ul><li>修复一个了在 <code>Alpine Linux</code> 下的编译错误（<a href="https://github.com/ADD-SP/ngx_waf/commit/e989aa34370da73f03627601188ca33844372c4f" target="_blank" rel="noopener noreferrer">e989aa3<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-0-1-2020-12-28"><a href="#_3-0-1-2020-12-28" class="header-anchor">#</a> [3.0.1] - 2020-12-28</h2> <h3 id="修复-17"><a href="#修复-17" class="header-anchor">#</a> 修复</h3> <ul><li>修复了一个在检查 Cookie 时的段错误（<a href="https://github.com/ADD-SP/ngx_waf/commit/8dc2b56e9a8ae7c22cc5309ac0a060b0358f545b" target="_blank" rel="noopener noreferrer">8dc2b56<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_3-0-0-2020-12-25"><a href="#_3-0-0-2020-12-25" class="header-anchor">#</a> [3.0.0] - 2020-12-25</h2> <h3 id="新增-9"><a href="#新增-9" class="header-anchor">#</a> 新增</h3> <ul><li><p>CC 防御现在也支持了 IPV6（<a href="https://github.com/ADD-SP/ngx_waf/commit/00fbc1c20ec964f6cd3bb992d756737e95b6c7ed" target="_blank" rel="noopener noreferrer">00fbc1c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li> <li><p>IP 黑白名单支持了 IPV6。可以识别形如 <code>fe80::/10</code> 的 IPV6 字符串（<a href="https://github.com/ADD-SP/ngx_waf/commit/8519b26f5fb9491ac60ae084247a0957c0931d0c" target="_blank" rel="noopener noreferrer">8519b26<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li></ul> <h3 id="改动-2"><a href="#改动-2" class="header-anchor">#</a> 改动</h3> <ul><li><p>删除了一些无用的日志（<a href="https://github.com/ADD-SP/ngx_waf/commit/bd279e7be872621fa75337722a9fae30b2ea6812" target="_blank" rel="noopener noreferrer">bd279e7<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li> <li><p>友好的错误提示（<a href="https://github.com/ADD-SP/ngx_waf/commit/d1185b26a413e45dcf5ef479b0078aa57a4b5962" target="_blank" rel="noopener noreferrer">d1185b2<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> &amp; <a href="https://github.com/ADD-SP/ngx_waf/commit/f2b617d5174eb1bc6982113415ddcb1f798ef703" target="_blank" rel="noopener noreferrer">f2b617d<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。当规则文件中 IP 地址无效或者 IP 地址块重叠的时候警告或者报错（并不能检测所有的重叠情况）。</p></li> <li><p>更快的 IP 地址检查速度（<a href="https://github.com/ADD-SP/ngx_waf/commit/2b9e77404826666df301c3d6b3ce07a6968de266" target="_blank" rel="noopener noreferrer">2b9e774<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。改用前缀树检查 IP，现在在常数时间内即可完成 IP 的匹配，之前是一个一个地匹配，是线性时间。</p></li></ul> <h3 id="修复-18"><a href="#修复-18" class="header-anchor">#</a> 修复</h3> <ul><li><p>修复了 Cookie 检查的失效的 bug（<a href="https://github.com/ADD-SP/ngx_waf/commit/87beed183e404c70411a2d35ea68ebbccccf5ff6" target="_blank" rel="noopener noreferrer">87beed1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li> <li><p>修改 <code>config</code> 文件以确保执行 <code>make</code> 或 <code>make modules</code> 时最新的模块代码能够被编译（<a href="https://github.com/ADD-SP/ngx_waf/commit/25f97f5e7f3792b131ab0ebb1bfe4b7fe5e330ae" target="_blank" rel="noopener noreferrer">25f97f5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。在修复之前，如果仅仅 <code>inc/</code> 下的文件发生变化，编译时不会将最新的代码编译进去，因为没有检查 <code>inc/</code> 下的文件是否发生变化。</p></li> <li><p>修复了 IPV4 网段识别错误的 bug（<a href="https://github.com/ADD-SP/ngx_waf/commit/73a22eb3538a24e9714bf8331946a5654df20cc1" target="_blank" rel="noopener noreferrer">73a22eb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。这个 bug 可能会导致当规则中出现类似 <code>192.168.0.0/10</code>，即后缀不是 8 的倍数的时候无法正确生成子网掩码。</p></li></ul> <hr> <h2 id="_2-1-1-2020-12-10"><a href="#_2-1-1-2020-12-10" class="header-anchor">#</a> [2.1.1] - 2020-12-10</h2> <h3 id="新增-10"><a href="#新增-10" class="header-anchor">#</a> 新增</h3> <h3 id="改动-3"><a href="#改动-3" class="header-anchor">#</a> 改动</h3> <h3 id="修复-19"><a href="#修复-19" class="header-anchor">#</a> 修复</h3> <ul><li>修复了模块启动失败的 bug。此 bug 的报错信息为 <code>nginx: [alert] could not open error log file: open() &quot;ngx_waf: /logs/error.log&quot; failed (2: No such file or directory)</code>（<a href="https://github.com/ADD-SP/ngx_waf/commit/0dfc46f2dfc7ed91977b501c868abf961966d4e1" target="_blank" rel="noopener noreferrer">0dfc46f<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_2-1-0-2020-12-09"><a href="#_2-1-0-2020-12-09" class="header-anchor">#</a> [2.1.0] - 2020-12-09</h2> <h3 id="新增-11"><a href="#新增-11" class="header-anchor">#</a> 新增</h3> <ul><li>兼容了 Mainline 版本的 nginx（<a href="https://github.com/ADD-SP/ngx_waf/commit/f31f906b11fb00f54bfea504ca7c8c147a0be1d8" target="_blank" rel="noopener noreferrer">f31f906<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> &amp; <a href="https://github.com/ADD-SP/ngx_waf/commit/7b4f897a4a332b43bf94de874f8ba8c3098aaee4" target="_blank" rel="noopener noreferrer">65277d1<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="改动-4"><a href="#改动-4" class="header-anchor">#</a> 改动</h3> <h3 id="修复-20"><a href="#修复-20" class="header-anchor">#</a> 修复</h3> <h2 id="_2-0-2-2020-12-07"><a href="#_2-0-2-2020-12-07" class="header-anchor">#</a> [2.0.2] - 2020-12-07</h2> <h3 id="新增-12"><a href="#新增-12" class="header-anchor">#</a> 新增</h3> <h3 id="改动-5"><a href="#改动-5" class="header-anchor">#</a> 改动</h3> <h3 id="修复-21"><a href="#修复-21" class="header-anchor">#</a> 修复</h3> <ul><li><p>修复了一个 CC 防御失效的 bug。此 bug 会导致当 <code>waf_mult_mount</code> 未启用时，CC 防御会失效（<a href="https://github.com/ADD-SP/ngx_waf/commit/048fe5c15863d9a3106387225774305aa5564726" target="_blank" rel="noopener noreferrer">048fe5c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li> <li><p>修复了一个因错误的 <code>#include</code> 指令而导致编译失败的 bug（<a href="https://github.com/ADD-SP/ngx_waf/commit/3fa298c6184618ea0cd6336783a4d7a2ed27469c" target="_blank" rel="noopener noreferrer">3fa298c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</p></li></ul> <hr> <h2 id="_2-0-1-2020-12-03"><a href="#_2-0-1-2020-12-03" class="header-anchor">#</a> [2.0.1] - 2020-12-03</h2> <h3 id="新增-13"><a href="#新增-13" class="header-anchor">#</a> 新增</h3> <h3 id="改动-6"><a href="#改动-6" class="header-anchor">#</a> 改动</h3> <ul><li>不再手动下载 uthash 依赖，改用 system library。可以使用 <code>yum install uthash-devel</code> 或 <code>apt-get install uthash-dev</code> 安装 system library（<a href="https://github.com/ADD-SP/ngx_waf/commit/7cfc94bc64fa4f2c29bdf3b24e21aeb1ba412054" target="_blank" rel="noopener noreferrer">7cfc94b<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="修复-22"><a href="#修复-22" class="header-anchor">#</a> 修复</h3> <ul><li>修复了因为宏的重定义导致的在 CentOS/RHEL 6 or 7 下编译失败的错误（<a href="https://github.com/ADD-SP/ngx_waf/commit/28e1c8aca03375089c75df21c5db3c38013edde7" target="_blank" rel="noopener noreferrer">28e1c8a<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> &amp; <a href="https://github.com/ADD-SP/ngx_waf/commit/566ae4a50f855674b256db84305a24e1b2a6bc6d" target="_blank" rel="noopener noreferrer">566ae4a<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_2-0-0-2020-09-29"><a href="#_2-0-0-2020-09-29" class="header-anchor">#</a> [2.0.0] - 2020-09-29</h2> <h3 id="新增-14"><a href="#新增-14" class="header-anchor">#</a> 新增</h3> <ul><li>支持以动态模块安装到 nginx 上，感谢 <a href="https://github.com/dvershinin" target="_blank" rel="noopener noreferrer">dvershinin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的 PR（https://github.com/ADD-SP/ngx_waf/pull/4）。</li></ul> <h3 id="改动-7"><a href="#改动-7" class="header-anchor">#</a> 改动</h3> <ul><li>配置指令合并 (<a href="https://github.com/ADD-SP/ngx_waf/commit/ba92cfd53ce78da8ff4ed22d2bc71a47de4cbe25" target="_blank" rel="noopener noreferrer">ba92cfd<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>)。这些配置指令将被合并：<code>waf_check_ipv4</code>，<code>waf_check_url</code>，<code>waf_check_args</code>，<code>waf_check_ua</code>，<code>waf_check_referer</code>，<code>waf_check_cookie</code>，<code>waf_check_post</code>，<code>waf_check_cookie</code>，<code>waf_cc_deny</code>。合并后的新指令为<code>waf_mode</code>，详情见<a href="/ngx_waf/zh-cn/advance/README-ZH.html">README</a>。</li></ul> <h3 id="修复-23"><a href="#修复-23" class="header-anchor">#</a> 修复</h3> <ul><li>删除一个默认的 User-Agent 规则，规则内容为<code>(?i)(?:Sogou web spider)</code>，原因是会拦截非恶意的网络爬虫（<a href="https://github.com/ADD-SP/ngx_waf/commit/827d4e5bc48894ff9147e49799d3a9656fe7dd8a" target="_blank" rel="noopener noreferrer">827d4e5<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>现在可以正确处理规则文件中的空行了（<a href="https://github.com/ADD-SP/ngx_waf/commit/955cf2d240c4d66f815890e3ee9b88ccf906cf1d" target="_blank" rel="noopener noreferrer">955cf2d<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_1-0-1-2020-08-22"><a href="#_1-0-1-2020-08-22" class="header-anchor">#</a> [1.0.1] - 2020-08-22</h2> <h3 id="新增-15"><a href="#新增-15" class="header-anchor">#</a> 新增</h3> <ul><li>增加了新的配置项（<a href="https://github.com/ADD-SP/ngx_waf/commit/3214fc88d565ed47daa4bdac4f0edb7d1785ed75" target="_blank" rel="noopener noreferrer">3214fc8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）
<ul><li>waf_check_ipv4:
<ul><li>配置语法: <code>waf_check_ipv4 [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 IPV4 检查。</li></ul></li> <li>waf_check_url:
<ul><li>配置语法: <code>waf_check_url [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 URL 检查。</li></ul></li> <li>waf_check_args:
<ul><li>配置语法: <code>waf_check_args [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 Args 检查。</li></ul></li> <li>waf_check_ua:
<ul><li>配置语法: <code>waf_check_ua [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 User-Agent 检查。</li></ul></li> <li>waf_check_referer:
<ul><li>配置语法: <code>waf_check_referer [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 Referer 检查。</li></ul></li> <li>waf_check_cookie:
<ul><li>配置语法: <code>waf_check_cookie [ on | off ];</code></li> <li>默认值：<code>on</code></li> <li>配置段: server</li> <li>作用：是否启用 Cookie 检查。</li></ul></li> <li>waf_check_post:
<ul><li>配置语法: <code>waf_check_post [ on | off ];</code></li> <li>默认值：<code>off</code></li> <li>配置段: server</li> <li>作用：是否启用 POST 检查。</li></ul></li> <li>waf_cc_deny:
<ul><li>配置语法: <code>waf_cc_deny [ on | off ];</code></li> <li>默认值：<code>off</code></li> <li>配置段: server</li> <li>作用：是否启用 CC 防御。</li></ul></li></ul></li></ul> <h3 id="改动-8"><a href="#改动-8" class="header-anchor">#</a> 改动</h3> <ul><li><code>waf_mult_mount</code>现在只允许写在<code>server</code>段中（<a href="https://github.com/ADD-SP/ngx_waf/commit/3214fc88d565ed47daa4bdac4f0edb7d1785ed75" target="_blank" rel="noopener noreferrer">3214fc8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。
<ul><li>waf_mult_mount:
<ul><li>配置语法: <code>waf_mult_mount [ on | off ];</code></li> <li>默认值：<code>off</code></li> <li>配置段: server</li> <li>作用：进行多阶段检查，当<code>nginx.conf</code>存在地址重写的情况下（如<code>rewrite</code>配置）建议启用，反之建议关闭。</li></ul></li></ul></li> <li>更改现有的配置项关键字，删除了<code>ngx_</code>前缀（<a href="https://github.com/ADD-SP/ngx_waf/commit/8b3e416cdfdc7e073a3392fc9ec027a4138af453" target="_blank" rel="noopener noreferrer">8b3e416<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。
<ul><li>waf:
<ul><li>配置语法: <code>waf [ on | off ];</code></li> <li>默认值：<code>off</code></li> <li>配置段: server</li> <li>作用：是否启用本模块。</li></ul></li> <li>waf_rule_path:
<ul><li>配置语法: <code>waf_rule_path dir;</code></li> <li>默认值：无</li> <li>配置段: server</li> <li>作用：规则文件所在目录，且必须以<code>/</code>结尾。</li></ul></li> <li>waf_mult_mount:
<ul><li>配置语法: <code>waf_mult_mount [ on | off ];</code></li> <li>默认值：<code>off</code></li> <li>配置段: http</li> <li>作用：进行多阶段检查，当<code>nginx.conf</code>存在地址重写的情况下（如<code>rewrite</code>配置）建议启用，反之建议关闭。</li></ul></li></ul></li> <li>更新 referer 的默认规则，具体一点就是拷贝<code>rules/url</code>的内容到<code>rules/referer</code>中（<a href="https://github.com/ADD-SP/ngx_waf/commit/55f5e26b6135af382b1db88057f5143631848ae7" target="_blank" rel="noopener noreferrer">55f5e26<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="修复-24"><a href="#修复-24" class="header-anchor">#</a> 修复</h3> <ul><li>修复 CC 防御功能检测逻辑的错误，该错误会导致实际的频率限制要远小于用户指定的限制，容易将正常访问识别为 CC 攻击（<a href="https://github.com/ADD-SP/ngx_waf/commit/9cb51bba0cdf10c2fd1ac0a482d7435dcfdee93d" target="_blank" rel="noopener noreferrer">9cb51bb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）（<a href="https://github.com/ADD-SP/ngx_waf/commit/171721cee861022e9f3db5fceeb16051b90a5e54" target="_blank" rel="noopener noreferrer">171721c<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>现在会检查 rules/ipv4 和 rules/white-ipv4 这两个文件中的 IPV4 地址或地址块是否合法（<a href="https://github.com/ADD-SP/ngx_waf/commit/fc09f045d1e9ac774a919181a15c20a6c777a276" target="_blank" rel="noopener noreferrer">fc09f04<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）（<a href="https://github.com/ADD-SP/ngx_waf/commit/2e7f624581d8d85a23d6470acced9acc3e2840b2" target="_blank" rel="noopener noreferrer">2e7f624<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <hr> <h2 id="_1-0-0-2020-08-18"><a href="#_1-0-0-2020-08-18" class="header-anchor">#</a> [1.0.0] - 2020-08-18</h2> <h3 id="新增-16"><a href="#新增-16" class="header-anchor">#</a> 新增</h3> <ul><li>改进日志格式（<a href="https://github.com/ADD-SP/ngx_waf/commit/bd112ecacd9356ee1e0731634cfc197034d25c88" target="_blank" rel="noopener noreferrer">bd112ec<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。基本格式为<code>xxxxx, ngx_waf: [拦截类型][对应规则], xxxxx</code>，具体可看下面的例子。<div class="language- extra-class"><pre class="language-text"><code>2020/01/20 22:56:30 [alert] 24289#0: *30 ngx_waf: [BLACK-URL][(?i)(?:/\.env$)], client: 192.168.1.1, server: example.com, request: &quot;GET /v1/.env HTTP/1.1&quot;, host: &quot;example.com&quot;, referrer: &quot;http:/example.com/v1/.env&quot;

2020/01/20 22:58:40 [alert] 24678#0: *11 ngx_waf: [BLACK-POST][(?i)(?:select.*(?:from|limit))], client: 192.168.1.1, server: example.com, request: &quot;POST /xmlrpc.php HTTP/1.1&quot;, host: &quot;example.com&quot;, referrer: &quot;https://example.com/&quot;
</code></pre></div></li> <li>新增三个内置变量（<a href="https://github.com/ADD-SP/ngx_waf/commit/92d6d847840ada57bbc54ffe2c0980b118a37a30" target="_blank" rel="noopener noreferrer">92d6d84<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）
<ul><li><code>$waf_blocked</code>: 本次请求是否被本模块拦截，如果拦截了则其的值为<code>'true'</code>,反之则为<code>'false'</code>。</li> <li><code>$waf_rule_type</code>：如果本次请求被本模块拦截，则其值为触发的规则类型。下面是可能的取值。若没有生效则其值为<code>'null'</code>。
<ul><li><code>'BLACK-IPV4'</code></li> <li><code>'BLACK-URL'</code></li> <li><code>'BLACK-ARGS'</code></li> <li><code>'BLACK-USER-AGENT'</code></li> <li><code>'BLACK-REFERER'</code></li> <li><code>'BLACK-COOKIE'</code></li> <li><code>'BLACK-POST'</code></li></ul></li> <li><code>'$waf_rule_details'</code>：如果本次请求被本模块拦截，则其值为触发的具体的规则的内容。若没有生效则其值为<code>'null'</code>。</li></ul></li> <li>支持过滤 POST 请求（<a href="https://github.com/ADD-SP/ngx_waf/commit/b46641eb8473c6dcb6afe9ed73f94712300d176f" target="_blank" rel="noopener noreferrer">b46641e<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>新配置项<code>ngx_waf_mult_mount</code>用于增加拦截面（<a href="https://github.com/ADD-SP/ngx_waf/commit/e1b500de349e017b67f334878342bdd6a34d22b8" target="_blank" rel="noopener noreferrer">e1b500d<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>），典型的应用场景是存在<code>rewrite</code>的情况下重写前后均会对 URL 进行一次检测。</li> <li>支持 CC 防御功能（<a href="https://github.com/ADD-SP/ngx_waf/commit/3a93e190b8cb78fcd7a0197f76298c010169d113" target="_blank" rel="noopener noreferrer">3a93e19<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <h3 id="改动-9"><a href="#改动-9" class="header-anchor">#</a> 改动</h3> <ul><li>增加默认的 POST 过滤规则（<a href="https://github.com/ADD-SP/ngx_waf/commit/68dd102e011acfd819669d60a35d315365d26a16" target="_blank" rel="noopener noreferrer">68dd102<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</li> <li>更新默认规则（<a href="https://github.com/ADD-SP/ngx_waf/commit/55f0a4824bafb67f562909bdb58292cfce1059ae" target="_blank" rel="noopener noreferrer">55f0a48<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>修改规则优先级（<a href="https://github.com/ADD-SP/ngx_waf/commit/3c388c85e30528b66306ca780524c7d663277f07" target="_blank" rel="noopener noreferrer">3c388c8<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）（<a href="https://github.com/ADD-SP/ngx_waf/commit/248958d3a0ef27dd14acc63a503e97931841f18a" target="_blank" rel="noopener noreferrer">248958d<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）（<a href="https://github.com/ADD-SP/ngx_waf/commit/b46641eb8473c6dcb6afe9ed73f94712300d176f" target="_blank" rel="noopener noreferrer">b46641e<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）（(92447a3)[https://github.com/ADD-SP/ngx_waf/commit/92447a39d6a36ab027b0ead0daa0fe2b3b74ff29]），现在的优先级为（靠上的优先生效）：
<ol><li>IP 白名单</li> <li>IP 黑名单</li> <li>CC 防御</li> <li>URL 白名单</li> <li>URL 黑名单</li> <li>Args 黑名单</li> <li>UserAgent 黑名单</li> <li>Referer 白名单</li> <li>Referer 黑名单</li> <li>Cookie 黑名单</li> <li>POST 黑名单</li></ol></li></ul> <h3 id="修复-25"><a href="#修复-25" class="header-anchor">#</a> 修复</h3> <ul><li>IPV4 黑白名单功能失效（<a href="https://github.com/ADD-SP/ngx_waf/commit/231f94aa5383fe8f6cdc0fbc3cd2dcadb7606881" target="_blank" rel="noopener noreferrer">231f94a<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>当 User-agent 为空时会触发 segmentation fault（<a href="https://github.com/ADD-SP/ngx_waf/commit/bf33b366232b7f5e05379d5e10ab006696189ea6" target="_blank" rel="noopener noreferrer">bf33b36<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li> <li>启用 CC 防御后会有内存泄漏（<a href="https://github.com/ADD-SP/ngx_waf/commit/be58d189b4c95be066623604124b02a9bf174e7f" target="_blank" rel="noopener noreferrer">be58d18<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ADD-SP/ngx_waf/edit/master/docs/zh-cn/advance/changes.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后一次更新:</span> <span class="time">2021/6/9上午10:59:52</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ngx_waf/zh-cn/advance/issue.html" class="prev">
        已知问题
      </a></span> <span class="next"><a href="/ngx_waf/zh-cn/todo/advanced-rule.html">
        高级规则
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ngx_waf/assets/js/app.7227ec30.js" defer></script><script src="/ngx_waf/assets/js/2.eb25f57f.js" defer></script><script src="/ngx_waf/assets/js/25.7e9e286f.js" defer></script>
  </body>
</html>
